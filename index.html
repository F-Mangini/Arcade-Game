<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogue-like 2D Arcade Game</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #222;
            font-family: Arial, sans-serif;
        }

        #canvas-container {
            position: relative;
            width: 90vw;
            max-width: 800px;
            margin: 0 auto;
        }

        #gameCanvas {
            display: block;
            aspect-ratio: 4 / 3;
            width: 100%;
            height: 100%;
            border: 2px solid #fff;
        }

        #gameOver, #winScreen, #gamePaused, #stats {
            display: none;
            position: absolute;
            top: 43%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.3);
            color: #fff;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
        }

        #gamePaused, #stats {
            background-color: rgba(0, 0, 0, 0.9);
        }

        #stats {
            text-align: left;
            width: 90%;
        }

        #stats ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #stats li {
            margin-bottom: 3px;
        }

        .stat-category {
            margin-bottom: 3px;
        }

        .stat-category h4 {
            margin-bottom: 3px;
            color: #FF6B6B;
            text-decoration: underline;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }

        .retryButt, .showStats, #resumeButton {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }

        .showStats {
            background-color: #FF6B6B;
        }

        #scoreboard {
            position: absolute;
            top: -30px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-size: 20px;
            font-family: Arial, sans-serif;
        }

        #hearts {
            text-align: left;
            margin-bottom: 4px;
            width: 23%;
        }

        #score {
            margin-left: 10px;
            text-align: left;
            width: 33%;
        }

        #audio-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        #musicButton, #soundButton {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }

        .audio-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .volume-slider {
            -webkit-appearance: none;
            width: 110px;
            height: 3px;
            background: #4CAF50;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            margin-top: 5px;
        }

        .volume-slider:hover {
            opacity: 1;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider-red {
            background: #FF6B6B !important;
        }
        .slider-red::-webkit-slider-thumb {
            background: #FF6B6B !important;
        }
        .slider-red::-moz-range-thumb {
            background: #FF6B6B !important;
        }
        .slider-green {
            background: #4CAF50 !important;
        }
        .slider-green::-webkit-slider-thumb {
            background: #4CAF50 !important;
        }
        .slider-green::-moz-range-thumb {
            background: #4CAF50 !important;
        }

        .audio-controls-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .goofy-text {
            font-size: 12px;
            color: #888;
            font-style: italic;
            text-align: right;
            margin-top: 10px;
        }
        
        .game-title {
            font-family: 'Press Start 2P', cursive;
            font-size: 6vw;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.7);
            transition: transform 0.3s ease;
        }

        .game-title:hover {
            transform: scale(1.1);
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        @media (max-width: 900px) {
            #stats {
                font-size: 1.6vw !important;
            }

            #gameOver, #winScreen, #gamePaused, #stats {
                padding: 10px;
                font-size: 2vw;
            }

            #goofy1 {
                font-size: 1.4vw !important;
            }

            .retryButt, .showStats, #resumeButton {
                padding: 15px 25px;
                font-size: 1.8vw;
            }
            
            .close-btn {
                font-size: 2.4vw;
            }

            #scoreboard {
                top: -5vw;
                font-size: 2.2vw;
            }

        }

        @media (max-width: 625px) {
            .game-title {
                font-size: 8vw;
            }

            #stats {
                width: 90%;
            }

            #gameOver, #winScreen, #gamePaused, #stats {
            top: 39%;
            }

            .retryButt, .showStats, #resumeButton {
                padding: 1.8vw 2.9vw;
                font-size: 2vw;
            }

            #scoreboard {
                font-size: 2.3vw;
            }

            .goofy-text {
                font-size: 2.2vw;
            }
        }

        @media (max-width: 450px) {
            .game-title {
                font-size: 6vw;
            }

            #gameOver, #winScreen, #gamePaused, #stats {
                top: 31%;
                padding: 7px;
            }

            .retryButt, .showStats, #resumeButton {
                padding: 2.3vw 3vw;
                font-size: 3vw;
            }

            .close-btn {
                font-size: 10px;
            }

            #audio-controls {
                flex-direction: column;
                align-items: center;
            }

            #musicButton, #soundButton {
                width: 100%;
            }

            .audio-control {
                width: 100% !important;
            }

            #musicButton, #soundButton {
                margin-top: 5px;
                font-size: 11px;
            }

            .goofy-text {
                font-size: 11px;
            }
        }

        @media (max-width: 300px) {

            #gameOver, #winScreen, #gamePaused, #stats {
                top: 28%;
                padding: 7px;
            }
        }

        @media (max-width: 200px) {

            #gameOver, #winScreen, #gamePaused, #stats {
                top: 24%;
                padding: 7px;
            }
        }

        #joystick-container {
            position: relative;
            top: 7px;
            bottom: 5px;
            left : 40%;
            width: 130px;
            height: 130px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            touch-action: none;
            display: none;
        }
        
        #joystick {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: #333;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .joystick-slider {
            -webkit-appearance: none;
            width: 110px;
            height: 3px;
            background: rgba(255, 255, 255, 1);
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            margin-top: 5px;
        }

        .joystick-slider:hover {
            opacity: 1;
        }

        .joystick-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 1);
            cursor: pointer;
        }

        .joystick-slider::-moz-range-thumb {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 1);
            cursor: pointer;
        }

        #pauseButton {
            background-color: rgba(155, 155, 155, 0.9);
            border: none;
            color: white;
            padding: 9px 13px;
            text-align: center;
            text-decoration: none;
            display: block;
            left: 3%;
            position: absolute;
            font-size: 8px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
        }

        @media (max-width: 768px) and (orientation: landscape) {
            #canvas-container {
                width: 50vw;
                margin-right: 30vw;
                right: 3%;
                margin-top: 10vw;
            }

            #joystick-container {
                position: fixed;
                left : 75%;
                top: 35%;
            }
        }
    </style>
</head>
    <!-- https://drive.google.com/file/d/1gl9NtrL6Am2LFeRv7gIqE_TBgarl2OR4/view?usp=sharing -->
<body>
    <div class="container"> 
        <div class="game-title"><a id="title" href="https://docs.google.com/document/d/1qBPB0o5j4DLpiHqMHwt4F7pj802QFePzVUUoAW31chw/edit?usp=sharing" target=”_blank”>Infection</a></div> 
        <div id="canvas-container">
            <div id="scoreboard">
                <div id="score"></div>
                <div id="hearts"></div>
            </div>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <button id="pauseButton">Pause</button>
            <div id="joystick-container">
                <div id="joystick"></div>
            </div>
            <div id="audio-controls">
                <input type="range" id="joystickSlider" class="joystick-slider" min="0" max="100" value="60">
                <div class="audio-control">
                    <button id="soundButton">Sound On</button>
                    <input type="range" id="soundSlider" class="volume-slider" min="0" max="100" value="100">
                </div>
                <div class="audio-control">
                    <button id="musicButton">Music On</button>
                    <input type="range" id="musicSlider" class="volume-slider" min="0" max="100" value="100">
                </div>
            </div>
            <p class="goofy-text">Please keep them on, I spent 3 days on these</p>
            <div id="gameOver">
                <h2>Game Over</h2>
                <h3 id='mark'>You should be dead</h3>
                <p>Your score: <span id="finalScore"></span></p>
                <button class="retryButt" id="retryButton">Retry</button>
                <button class="showStats" onclick="openStats()">Stats</button>
            </div>

            <div id="winScreen">
                <h2>Congratulations</h2>
                <h3>You won</h3>
                <p>Your score: <span id="finalScore2"></span></p>
                <button class="retryButt" id="retryButton2">Play again</button>
            </div>

            <div id="gamePaused">
                <h2>Game Paused</h2>
                <h3>You must be busy</h3>
                <p>Check out the stats!</p> 
                <p class="goofy-text" id="goofy1">Seriously, I spent 5 hours implementing them.</p>
                <button id="resumeButton">Resume</button>
                <button class="showStats" onclick="openStats()">Stats</button>
            </div>

            <div id="stats">
                <button class="close-btn" onclick="closeStats()">x</button>
                <h2>Stats</h2>
                <div class="stat-category">
                    <h4>Enemies</h4>
                    <ul>
                        <li>Total: <span id="totEnemies"></span></li>
                        <li>Destroyed: <span id="destroyedEnemies"></span></li>
                        <li>Eaten: <span id="eatenEnemies"></span></li>
                        <li>Faded: <span id="fadedEnemies"></span></li>
                    </ul>
                </div>
                <div class="stat-category">
                    <h4>Bullets</h4>
                    <ul>
                        <li>Fired at you: <span id="totBullets"></span></li>
                        <li>Hit by: <span id="hitBullets"></span></li>
                    </ul>
                </div>
                <div class="stat-category">
                    <h4>PowerUps</h4>
                    <ul>
                        <li>Total: <span id="totPowerups"></span></li>
                        <li>Collected: <span id="collectedPowerups"></span></li>
                    </ul>
                </div>
                <div class="stat-category">
                    <h4>Health</h4>
                    <ul>
                        <li>Hearts Lost: <span id="heartsLost"></span></li>
                        <li>Shields Lost: <span id="shieldsLost"></span></li>
                    </ul>
                </div>
                <div class="stat-category">
                    <h4>Achievements</h4>
                    <ul>
                        <li>Statistician: <span id="statistician"></span></li>
                        <li>Pacifist: <span id="pacifist"></span></li>
                        <li>Back from the Dead: <span id="backFromTheDead"></span></li>
                        <li>Loops: <span id="loopsCompleted"></span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
        
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const GAME_WIDTH = 800;
        const GAME_HEIGHT = 600;
        const PLAYER_SIZE = 20;
        const POWERUP_SIZE = 15;

        let player = {
            x: GAME_WIDTH / 2,
            y: GAME_HEIGHT / 2,
            size: PLAYER_SIZE,
            speed: 5,
            hearts: 1,
            invincible: 0,
            shield: false,
            slowMo: 0,
            gotHit: false
        };

        //ENEMIES
        const ENEMY_TYPES = [
            { color: '#45D191', name: 'Green', speed: 1.5, shootRange: 220, shootCooldown: 110, teleport: false, baseBulletSpeed: 3, bulletRange: 250, bulletSpread: Math.PI/4, bulletSize: 9, rapidFire: false, burstCount: 1, size: 21 },
            { color: '#FF6B6B', name: 'Red', speed: 1, shootRange: 340, shootCooldown: 230, teleport: false, baseBulletSpeed: 2.5, bulletRange: 360, bulletSpread: 0, bulletSize: 10, rapidFire: false, burstFire: true, burstCount: 3, burstDelay: 15, size: 24 },
            { color: '#EF9B3D', name: 'Orange', speed: 0.7, shootRange: 800, minShootRange: 400, shootCooldown: 280, teleport: false, baseBulletSpeed: 8, bulletRange: 1000, bulletSpread: 0, bulletSize: 17, rapidFire: false, burstCount: 1, size: 25 }, //#F1A94E
            { color: '#3A9C97', name: 'Blue', speed: 0.5, shootRange: 450, minShootRange: 100, shootCooldown: 490, teleport: true, baseBulletSpeed: 2.3, bulletRange: 1300, bulletSpread: Math.PI/8, bulletSize: 11, rapidFire: true, wrapBullets: true, burstCount: 2, size: 27 },
            { color: '#F14E8A', name: 'Pink', speed: 1.25, shootRange: 500, minShootRange: 150, shootCooldown: 1550, teleport: false, baseBulletSpeed: 1.5, bulletRange: 1700, bulletSpread: 2 * Math.PI, bulletSize: 7, rapidFire: false, followPlayer: true, burstCount: 4, size: 29 },
            { color: '#D694E5', name: 'Purple', speed: 2.2, shootRange: 150, shootCooldown: 1000, teleport: false, baseBulletSpeed: 4.5, bulletRange: 170, bulletSpread: Math.PI/9, bulletSize: 7, rapidFire: false, burstFire: true, burstCount: 90, burstDelay: 7, size: 31 },
            { color: '#F7D358', name: 'Yellow', speed: 0.4, spawnRange: 9000, spawnCooldown: 500, teleport: false, spawnSpread: 2 * Math.PI, rapidFire: false, spawnBurstFire: true, spawnBurstCount: 5, spawnBurstDelay: 70, baseSpawnEnemySpeed: 1.1, shootRange: 170, bulletSpread: Math.PI, shootCooldown: 7, baseBulletSpeed: 2.5, bulletRange: 90, bulletSize: 8.5, burstFire: true, burstCount: 10, burstDelay: 2, size: 35 },
            { color: '#47A3FF', name: 'Azure', speed: 1.1, shootRange: 180, shootCooldown: 40, teleport: false, baseBulletSpeed: 2.5, bulletRange: 100, bulletSpread: Math.PI/6, bulletSize: 7, rapidFire: false, burstFire: true, burstCount: 2, burstDelay: 10, size: 18 }
        ];

        //MOD
        let mod = 3;

        const MOD3 = ['#45D191', '#45D191', '#45D191', '#FF6B6B', '#45D191', '#FF6B6B', '#FF6B6B', '#EF9B3D', '#45D191', '#45D191', '#45D191'];

        const MOD4 = ['#FF6B6B', '#45D191', '#FF6B6B', '#45D191', '#FF6B6B', '#EF9B3D', '#45D191', '#EF9B3D', '#FF6B6B', '#EF9B3D', '#FF6B6B', '#45D191', '#3A9C97', '#45D191', '#45D191', '#45D191'];

        const MOD5 = ['#45D191', '#FF6B6B', '#EF9B3D', '#45D191', '#FF6B6B', '#FF6B6B', '#45D191', '#EF9B3D', '#3A9C97', '#45D191', '#FF6B6B', '#EF9B3D', '#45D191', '#3A9C97', '#FF6B6B', '#FF6B6B', '#45D191', '#EF9B3D', '#3A9C97', '#EF9B3D', '#FF6B6B', '#3A9C97', '#F14E8A', '#45D191', '#45D191'];

        const MOD6 = ['#45D191', '#FF6B6B', '#EF9B3D', '#3A9C97', '#FF6B6B', '#EF9B3D', '#45D191', '#3A9C97', '#45D191', '#FF6B6B', '#FF6B6B', '#F14E8A', '#EF9B3D', '#3A9C97', '#F14E8A', '#45D191', '#FF6B6B', '#EF9B3D', '#3A9C97', '#45D191', '#FF6B6B', '#EF9B3D', '#45D191', '#FF6B6B', '#F14E8A', '#EF9B3D', '#3A9C97', '#D694E5', '#45D191', '#45D191'];

        const MOD7 = ['#45D191', '#FF6B6B', '#EF9B3D', '#45D191', '#3A9C97', '#F14E8A', '#45D191', '#FF6B6B', '#EF9B3D', '#3A9C97', '#45D191', '#FF6B6B', '#D694E5', '#FF6B6B', '#45D191', '#EF9B3D', '#3A9C97', '#F14E8A', '#45D191', '#F14E8A', '#FF6B6B', '#3A9C97', '#F14E8A', '#FF6B6B', '#EF9B3D', '#3A9C97', '#F14E8A', '#D694E5', '#45D191', '#FF6B6B', '#45D191', '#45D191', '#FF6B6B', '#45D191', '#F7D358'];

        const MOD8 = [...MOD3, ...MOD4, ...MOD5, ...MOD6, ...MOD7];

        //POWERUPS
        const POWERUP_TYPES = [
            { type: 'glitch', color: 'lime', duration: 0 },
            { type: 'slowMo', color: 'magenta', duration: 5500 },
            { type: 'heart', color: 'red', duration: 0 },
            { type: 'shield', color: 'cyan', duration: 0 },
            { type: 'invincible', color: 'gold', duration: 4500 },
            //{ type: 'size', color: 'white', duration: 0 },
        ];

        // STATS
        let heartsLost = 0;
        let loopsCompleted = 0;
        let backFromTheDead = false;
        let shieldsLost = 0;
        let mark = "You're trash.";
        let hitBullets = {};
        let totBullets = {};
        let destroyedEnemies = {};
        let fadedEnemies = {};
        let totEnemies = {};
        let eatenEnemies = {};
        ENEMY_TYPES.forEach(enemy => {
            totBullets[enemy.name] = 0;
            hitBullets[enemy.name] = 0;
            destroyedEnemies[enemy.name] = 0;
            eatenEnemies[enemy.name] = 0;
            fadedEnemies[enemy.name] = 0;
            totEnemies[enemy.name] = 0;
        });
        let totPowerups = {};
        let collectedPowerups = {};
        POWERUP_TYPES.forEach(powerup => {
            totPowerups[powerup.type] = 0;
            collectedPowerups[powerup.type] = 0;
        });
        
        //INIT
        let first = true;
        let enemies = [];
        let bullets = [];
        let powerups = [];
        let score = 0;
        let difficulty = 1;
        let difficulty2 = 1;
        let lastHeartRecovery = 0;
        let gameStarted = false;
        let gameAlmostOver = false;
        let enemySpawnQueue = [...MOD8];
        let nextEnemySpawnTime = 0;
        let step = 300;
        let multiplier = 1;
        let interval = 100;
        let lastSizeUpdate = 0;
        let loop = false;
        let playerWon = false;
        let gamePaused = false;
        let gameTOver = true;
        let rings = [];
        let particles = [];
        let invAnimation = false;
        let hearts_max = 3;
        let statistician = false;
        let pacifist = false;
        let musicVolume = 1;
        let soundEffectsVolume = 1;

        let now = performance.now();
        let lastTime = now;
        let deltaTime = 0;

        //MUSIC
        let backgroundMusic;
        let menuMusic = new Audio('Menu-mix.mp3');
        let matchMusic = new Audio('Music-1.mp3');
        backgroundMusic = menuMusic;
        let isMusicPlaying = true;
        let currentPlaybackRate = 1;

        // SOUNDS
        let azureShot = new Audio('sound-effects/laser-gun-one-shot-nice-two.mp3');
        let yellowShot = new Audio('sound-effects/laserswoosh-one-shot-noisy.mp3');
        let yellowRelease = new Audio('sound-effects/flying-by-3.mp3');
        let purpleShot = new Audio('sound-effects/laser-simple-short-one-shot-new.mp3');
        let pinkShot = new Audio('sound-effects/flying-by-2-new.mp3');
        let blueShot = new Audio('sound-effects/laser-teleport-gun-new.mp3');
        let blueTeleport = new Audio('sound-effects/laser-one-shot-low-bolt.mp3');
        let orangeShot = new Audio('sound-effects/laser-blaster-one-shot-nice.mp3')
        let redShot = new Audio('sound-effects/laser-fire-one-shot-noisy-new.mp3');
        let greenShot = new Audio('sound-effects/classic-piouh-one-shot-nice-new.mp3');

        let finalHit = new Audio('sound-effects/deep-hit-final-new.mp3');
        let crashCrunch = new Audio('sound-effects/cracking-bones-crash-new.mp3');
        let crashBase = new Audio('sound-effects/destruction-crash-new.mp3');
        let glitch = new Audio('sound-effects/glitch-sound.mp3');
        let heartGain = new Audio('sound-effects/cartoon-slurp-new.mp3');
        let metalHit = new Audio('sound-effects/metal-dagger-hit-new.mp3');
        let bulletHit = new Audio('sound-effects/bullet-hit-soft-new.mp3');
        let biteEnemy = new Audio('sound-effects/apple-bite.mp3');
        let shieldBreak = new Audio('sound-effects/shield-break.mp3');
        let popPowerUp = new Audio('sound-effects/pop-power-up.mp3');
        let timeBack = new Audio('sound-effects/time-back-swoosh.mp3');
        let timeSlowing = new Audio('sound-effects/time-slowing-noisy.mp3');
        let menuToggle = new Audio('sound-effects/menu-toggle.mp3');
        let soundEffect;
        let isSoundEnabled = true;
        
        function draw() {
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            const scale = ['', '#B8B8B8', '#D0D0D0', '#E8E8E8', 'F4F4F4', 'white'];
            fillColor = scale[player.hearts];

            ctx.fillStyle = invAnimation ? 'gold' : (player.shield ? 'cyan' : ( player.gotHit ? 'red' : (gameAlmostOver ? '#818181' : fillColor)));
            ctx.fillRect(player.x, player.y, player.size, player.size);

            enemies.forEach(enemy => {
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, enemy.size, enemy.size);
            });

            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.size / 2, 0, Math.PI * 2);
                ctx.fill();
            });

            powerups.forEach(powerup => {
                ctx.fillStyle = powerup.color;
                ctx.beginPath();
                ctx.moveTo(powerup.x + POWERUP_SIZE / 2, powerup.y);
                ctx.lineTo(powerup.x, powerup.y + POWERUP_SIZE);
                ctx.lineTo(powerup.x + POWERUP_SIZE, powerup.y + POWERUP_SIZE);
                ctx.closePath();
                ctx.fill();
            });

            ctx.fillStyle = 'white';
            ctx.font = '20px Arial';
            if (!gameStarted) {
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.fillText(`Use WASD`, GAME_WIDTH/2 - 40, GAME_HEIGHT/2 - 100);
                ctx.fillText(`If you think it's a bug re-think`, GAME_WIDTH/2 - 120, GAME_HEIGHT/2 - 50);
                ctx.fillText(`Just keep playing`, GAME_WIDTH/2  - 70, GAME_HEIGHT/2 - 20);
                ctx.fillText(`Press Q to pause`, GAME_WIDTH  - 170, 30);
            }

            rings.forEach (ring => {
                drawRing(ring);
            });
            rings = rings.filter (ring => {
                if (ring.radius === 9999) {
                    return false;
                }
                return true;
            });

            particles.forEach(particle => {
                ctx.fillStyle = particle.color;
                ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
            });
            particles = particles.filter(particle => {
                return particle.alive;
            });
            
        }

        function destroyAnim(color, x, y){
            for (let i = 0; i < 7; i++) {
                const particle = {
                    color : color,
                    x : x + Math.random() * 5, 
                    y : y + Math.random() * 5,
                    duration : (Math.random() * 500) + 700,
                    size : (Math.random() * 4) + 5,
                    speed : (Math.random() * 1.8) + 0.7,
                    moveAngle : Math.random() * Math.PI * 2,
                    alive : true
                }
                setTimeout(function(){
                    particle.alive = false;
                }, particle.duration);
                particles.push(particle);
            }
            if (color === '#EF9B3D') {
                for (let i = 0; i < 5; i++) {
                    const particle = {
                        color : color,
                        x : x + Math.random() * 5, 
                        y : y + Math.random() * 5,
                        duration : (Math.random() * 500) + 700,
                        size : (Math.random() * 5) + 6,
                        speed : (Math.random() * 2.6) + 4,
                        moveAngle : Math.random() * Math.PI * 2,
                        alive : true
                    }
                    setTimeout(function(){
                        particle.alive = false;
                    }, particle.duration);
                    particles.push(particle);
                }
            }
            if (color === '#3A9C97') {
                for (let i = 0; i < 10; i++) {
                    const particle = {
                        color : color,
                        x : x + Math.random() * 5, 
                        y : y + Math.random() * 5,
                        duration : (Math.random() * 1000) + 700,
                        size : (Math.random() * 4) + 5,
                        speed : (Math.random() * 2) + 0.4,
                        moveAngle : Math.random() * Math.PI * 2,
                        alive : true
                    }
                    setTimeout(function(){
                        particle.alive = false;
                    }, particle.duration);
                    particles.push(particle);
                }
            }
            if (color === '#F14E8A') {
                for (let i = 0; i < 15; i++) {
                    const particle = {
                        color : color,
                        x : x + Math.random() * 5, 
                        y : y + Math.random() * 5,
                        duration : (Math.random() * 1400) + 700,
                        size : (Math.random() * 2) + 2.5,
                        speed : (Math.random() * 2.6) + 0.6,
                        moveAngle : Math.random() * Math.PI * 2,
                        alive : true
                    }
                    setTimeout(function(){
                        particle.alive = false;
                    }, particle.duration);
                    particles.push(particle);
                }
            }
            if (color === '#D694E5') {
                for (let i = 0; i < 20; i++) {
                    const particle = {
                        color : color,
                        x : x + Math.random() * 5, 
                        y : y + Math.random() * 5,
                        duration : (Math.random() * 1700) + 800,
                        size : (Math.random() * 4) + 2.1,
                        speed : (Math.random() * 3) + 3.1,
                        moveAngle : Math.random() * Math.PI * 2,
                        alive : true
                    }
                    setTimeout(function(){
                        particle.alive = false;
                    }, particle.duration);
                    particles.push(particle);
                }
            }
            if (color === '#F7D358') {
                for (let i = 0; i < 30; i++) {
                    const particle = {
                        color : color,
                        x : x + Math.random() * 5, 
                        y : y + Math.random() * 5,
                        duration : (Math.random() * 3300) + 1100,
                        size : (Math.random() * 7) + 3,
                        speed : (Math.random() * 2.6) + 0.4,
                        moveAngle : Math.random() * Math.PI * 2,
                        alive : true
                    }
                    setTimeout(function(){
                        particle.alive = false;
                    }, particle.duration);
                    particles.push(particle);
                }
            }
        }

        function updateParticles(){
            particles.forEach(particle => {
                    particle.x += Math.cos(particle.moveAngle) * particle.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                    particle.y += Math.sin(particle.moveAngle) * particle.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
            });
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function drawRing(ring) {
            if (ring.radius <= (GAME_WIDTH + GAME_HEIGHT)) {
                ctx.beginPath();
                ctx.arc(ring.x, ring.y, ring.radius, 0, Math.PI * 2);
                const alpha = 1 - ring.radius / (GAME_WIDTH + GAME_HEIGHT);
                ctx.strokeStyle = hexToRgba(ring.color, alpha);
                ctx.lineWidth = 3;
                ctx.stroke();
                ring.radius += 20 * deltaTime;
            }  else {ring.radius = 9999;}
        }

        function spawnRing(x, y, colorHex) {
            let ring = {
                radius : 1,
                color : colorHex,
                x : x + 5,
                y : y + 5,
            }
            rings.push(ring);
        }

        function startGame() {
            if (isMusicPlaying) {
                backgroundMusic.volume = 0;
                backgroundMusic = matchMusic;
                backgroundMusic.loop = true;
                backgroundMusic.volume = musicVolume;
                backgroundMusic.currentTime = 0;
                backgroundMusic.play();
            }
            else {backgroundMusic.volume = 0;
                 backgroundMusic = matchMusic;}
            gameStarted = true;
            gameTOver = false;
            nextEnemySpawnTime = 0;
            requestAnimationFrame(gameLoop);}

        function gameLoop() {
            now = performance.now();
            deltaTime = (now - lastTime) / 21;
            lastTime = now;
            if (first) {deltaTime = 0; 
                        first = false;
                       }
            
            if ( (keys.Escape || keys.q) && !gamePaused){
                if (!gameTOver) {
                    if (isSoundEnabled) {
                        playSoundEffect(menuToggle);
                    }
                    document.getElementById('gamePaused').style.display = 'block';
                    
                    if (isMusicPlaying) {
                        backgroundMusic.volume = 0.4;
                        setTimeout(function() {
                            backgroundMusic.volume = 0;
                            backgroundMusic = menuMusic;
                            backgroundMusic.loop = true;
                            backgroundMusic.volume = musicVolume;
                            backgroundMusic.playbackRate = 1;
                            backgroundMusic.play();}, 240);
                    }
                    else {
                        backgroundMusic.volume = 0;
                        backgroundMusic.playbackRate = 1;
                        backgroundMusic = menuMusic;
                    }
                    gamePaused = true;  
                }
            }
            if (gameTOver) {
                updateParticles();
                draw();
            }
            if (!gamePaused && !gameTOver) {

                backgroundMusic.playbackRate = player.slowMo ? currentPlaybackRate/ 2 : currentPlaybackRate;
                if (score < 5000) {
                    player.invincible = 0;
                    player.slowMo = 0;
                    invAnimation = false;
                }
                updateScoreboard();

                updatePlayer();
                updateEnemies();
                updateBullets();
                updatePowerups();
                updateParticles();

                if (score >= nextEnemySpawnTime) {
                    nextEnemySpawnTime = score + step * Math.sqrt(multiplier) * Math.sqrt(difficulty) / difficulty2;
                    spawnEnemy();
                }
                if (score > interval == 0) {
                    interval += 100;
                    enemies.forEach(enemy => {
                        enemy.bulletSpeed = enemy.baseBulletSpeed * (1 + (Math.atan((difficulty/90)**2))/1.2);
                        if (enemy.spawnBurstFire) {
                            enemy.spawnEnemySpeed = enemy.baseSpawnEnemySpeed * (1 + (Math.atan((difficulty/180)**2))/1.2)
                        }
                    });
                }
                if (score > 5000 && Math.random() < 0.0010 * deltaTime * Math.sqrt(multiplier)) spawnPowerup();

                score += Math.round(1 * deltaTime * multiplier);
                difficulty += 0.0005 * deltaTime;

                if (score - lastHeartRecovery >= 1000 && player.hearts < hearts_max && !gameAlmostOver) {
                    playSoundEffect(heartGain);
                    player.hearts++;
                    lastHeartRecovery = score;
                }
                if (score - lastSizeUpdate >= 5000) {
                    enemies = enemies.filter(enemy => {
                        if (enemy.size < 16) {
                            fadedEnemies[enemy.name]++;
                            pacifist = true;
                            return false;
                        } else {
                            if (enemy.name === "Green" || enemy.name === "Red" ) {
                                enemy.size = enemy.size - 3; // || enemy.name === "Orange"
                            } else {
                                enemy.size = enemy.size - 2;}
                            if (enemy.bulletSize > 4.5) {
                                enemy.bulletSize --;
                            }
                        return true;
                        }
                    });
                    lastSizeUpdate = score;
                }
                draw();
            }
            requestAnimationFrame(gameLoop);

        }

        function gameOver() {
            if (document.getElementById('winScreen').style.display !== 'block') {
                document.getElementById('gameOver').style.display = 'block';
                document.getElementById('finalScore').textContent = score;
                currentPlaybackRate += 0.6;
            }
            if (gameAlmostOver) {
                playSoundEffect(finalHit);
                player.size = 0;
                for (let i = 0; i < 25; i++) {
                    const particle = {
                        color : '#818181',
                        x : player.x + 10 + Math.random() * 5, 
                        y : player.y + 10 + Math.random() * 5,
                        duration : (Math.random() * 2900) + 800,
                        size : (Math.random() * 5.5) + 3,
                        speed : (Math.random() * 4) + 0.1,
                        moveAngle : Math.random() * Math.PI * 2,
                        alive : true
                    }
                    setTimeout(function(){
                        particle.alive = false;
                    }, particle.duration);
                    particles.push(particle);
                }
                
                if (isMusicPlaying) {
                    setTimeout(function() {
                        backgroundMusic.volume = 0;
                        backgroundMusic = menuMusic;
                        backgroundMusic.loop = true;
                        backgroundMusic.volume = musicVolume;
                        backgroundMusic.playbackRate = 1;
                        backgroundMusic.play();}, 240);
                } else {
                    backgroundMusic.volume = 0;
                    backgroundMusic = menuMusic;
                    backgroundMusic.playbackRate = 1;
                }
                gameTOver = true;
                document.getElementById('mark').textContent = mark;
                updateScoreboard();
            }
            gameAlmostOver = true;
        }

        function spawnEnemy() {
            if (enemySpawnQueue.length === 0 && mod === 2) {
                enemySpawnQueue = [...MOD7];
                difficulty2 += 0.5;
                return;}

            if (loop === false && mod === 3) {
                if (enemySpawnQueue.length === 110) {
                    currentPlaybackRate += 0.2;
                    difficulty2 += -0.2;}
                if (enemySpawnQueue.length === 99) {
                    currentPlaybackRate += 0.2;
                    mark = "You've got a long way to go.";
                    difficulty2 += 1.6;}
                if (enemySpawnQueue.length === 92) {
                    currentPlaybackRate += 0.2;
                    difficulty2 += -0.95;}
                if (enemySpawnQueue.length === 77) {
                    currentPlaybackRate += 0.2;
                    mark = "You are learning, don't quit.";
                    }
                if (enemySpawnQueue.length === 66) {
                    currentPlaybackRate += 0.2;
                    difficulty2 += 0.1;}
                if (enemySpawnQueue.length === 54) {
                    currentPlaybackRate += 0.2;
                    mark = "You're quite good at this game.";
                    difficulty2 += 0.15;}
                if (enemySpawnQueue.length === 46) {
                    currentPlaybackRate += 0.2;
                    difficulty2 += 0.1;}
                if (enemySpawnQueue.length === 35) {
                    currentPlaybackRate += 0.2;
                    mark = "You're on the way to success.";
                    difficulty2 += 0.2;}
                if (enemySpawnQueue.length === 15) {
                    currentPlaybackRate += 0.2;
                    difficulty2 += 0.15;}
            }
            if (enemySpawnQueue.length === 0 && mod === 3) {
                if (!loop) {
                    currentPlaybackRate += 0.2;
                    mark = "You were so fkn close.";}
                enemySpawnQueue = [...MOD8];
                loop = true;
                difficulty2 += 0.15;}

            const enemyColor = enemySpawnQueue.shift();
            const type = ENEMY_TYPES.find(t => t.color === enemyColor);
            const enemy = {
                x: Math.random() * (GAME_WIDTH - 35),
                y: Math.random() * (GAME_HEIGHT - 35),
                ...type,
                shootTimer: 0,
                targetPlayer: false,
                targetChangeTimer: 0,
                moveAngle: Math.random() * Math.PI * 2
            };
            enemy.shootTimer = (0.5 + Math.random()/2) * enemy.shootCooldown;
            if (enemy.spawnBurstFire) {
                enemy.spawnTimer = (0.5 + Math.random()/2) * enemy.spawnCooldown;
                enemy.spawnEnemySpeed = enemy.baseSpawnEnemySpeed;
            }
            enemy.bulletSpeed = enemy.baseBulletSpeed;
            do {
                    enemy.x = Math.random() * (GAME_WIDTH - enemy.size);
                    enemy.y = Math.random() * (GAME_HEIGHT - enemy.size);
                } while (Math.abs(enemy.x - player.x) < player.size * 7 && Math.abs(enemy.y - player.y) < player.size * 7);

            totEnemies[enemy.name]++;
            enemies.push(enemy);
        }

        function spawnPowerup() {
            const type = POWERUP_TYPES[Math.floor(Math.random() * POWERUP_TYPES.length)];
            const powerup = {
                x: Math.random() * (GAME_WIDTH - POWERUP_SIZE),
                y: Math.random() * (GAME_HEIGHT - POWERUP_SIZE),
                size: POWERUP_SIZE,
                ...type,
                lifespan: (Math.random() * 300) + 300
            };
            powerups.push(powerup);
            totPowerups[type.type]++;
        }

        function updatePlayer() {
            if (keys.w && player.y > 0) player.y -= player.speed * (player.slowMo ? 0.65 : 1) * deltaTime;
            if (keys.s && player.y < GAME_HEIGHT - player.size) player.y += player.speed * (player.slowMo ? 0.65 : 1) * deltaTime;
            if (keys.a && player.x > 0) player.x -= player.speed * (player.slowMo ? 0.65 : 1) * deltaTime;
            if (keys.d && player.x < GAME_WIDTH - player.size) player.x += player.speed * (player.slowMo ? 0.65 : 1) * deltaTime;
        }

        function updateEnemies() {
            enemies = enemies.filter( enemy => {
                if (
                    enemy.x + enemy.size > player.x &&
                    enemy.x < player.x + player.size &&
                    enemy.y + enemy.size > player.y &&
                    enemy.y < player.y + player.size &&
                    enemy.size < player.size
                ) { if (player.hearts < hearts_max) {
                        playSoundEffect(biteEnemy);
                        playSoundEffect(heartGain);
                        eatenEnemies[enemy.name]++;
                        player.hearts++;
                        player.size += 4;
                        player.x = enemy.x - (player.size - enemy.size) / 2;
                        player.y = enemy.y - (player.size - enemy.size) / 2;
                        setTimeout(function() {
                            player.size -= 4;
                            player.x += 2;
                            player.y += 2;
                        }, 300);
                        if (gameAlmostOver === true) {
                            if (document.getElementById('gameOver').style.display === 'block') {
                                document.getElementById('gameOver').style.display = 'none';
                                currentPlaybackRate -= 0.6;
                                backFromTheDead = true;
                            }
                        }
                        if (enemy.color === '#F7D358') {
                            destroyAnim(enemy.color, enemy.x + enemy.size/2, enemy.y + enemy.size/2);
                        }
                    
                    } else {
                        playSoundEffect(crashCrunch);
                        playSoundEffect(crashBase);
                        destroyedEnemies[enemy.name]++;
                        destroyAnim(enemy.color, enemy.x + enemy.size/2, enemy.y + enemy.size/2);
                    }
                    if (enemy.color === '#F7D358') {
                        document.getElementById('stats').style.display = 'none';
                        document.getElementById('winScreen').style.display = 'block';
                        if (document.getElementById('gameOver').style.display === 'block') {
                            document.getElementById('gameOver').style.display = 'none';
                            currentPlaybackRate -= 0.6;}
                        document.getElementById('finalScore2').textContent = score;
                        
                        if (isMusicPlaying) {
                            backgroundMusic.volume = 0;
                            menuMusic = new Audio('Arcade-Victory-menu.mp3');
                            matchMusic = new Audio('Pixelated-Victory.mp3');
                            backgroundMusic = matchMusic;
                            backgroundMusic.play();
                            backgroundMusic.loop = true;
                            backgroundMusic.currentPlaybackRate = 1;
                            backgroundMusic.volume = musicVolume;}
                        else {backgroundMusic.volume = 0;
                            backgroundMusic = matchMusic;}
                        mark = "You're amazing. Deserved it.";
                        document.getElementById('hearts').style.width = '30%';
                        hearts_max = 5;
                        player.hearts = hearts_max;
                        player.shield = true;
                        playerWon = true;
                        loopsCompleted++;
                        if (loopsCompleted > 1) {mark = "You're the GOAT. Respect.";}
                    }
                    
                    return false;}
                    
                return true;
            });
            
            enemies.forEach(enemy => {
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                enemy.targetChangeTimer = enemy.targetChangeTimer - 1 * deltaTime;

                if (enemy.targetChangeTimer <= 0) {
                    enemy.targetPlayer = Math.random() < 0.2;
                    enemy.targetChangeTimer = Math.floor(Math.random() * 120) + 60;
                    if (!enemy.targetPlayer) {
                        enemy.moveAngle = Math.random() * Math.PI * 2;
                    }
                }
                if (enemy.color === '#D694E5' && distance < 230) {
                    const dx = player.x + player.size/2 - enemy.x - enemy.size;
                    const dy = player.y + player.size/2 - enemy.y - enemy.size;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx);
                    enemy.moveAngle = angle;
                }
                if (enemy.color === '#47A3FF' && distance < 200) {
                    const dx = player.x + player.size/2 - enemy.x - enemy.size;
                    const dy = player.y + player.size/2 - enemy.y - enemy.size;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx);
                    enemy.moveAngle = angle;
                }
                if (enemy.color === '#F14E8A' && distance < 170) {
                    const dx = player.x + player.size/2 - enemy.x - enemy.size;
                    const dy = player.y + player.size/2 - enemy.y - enemy.size;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx);
                    enemy.moveAngle = angle + Math.PI;
                }

                if (enemy.targetPlayer && enemy.color !== '#F14E8A') {
                    enemy.x += (dx / distance) * enemy.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                    enemy.y += (dy / distance) * enemy.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                } else {
                    enemy.x += Math.cos(enemy.moveAngle) * enemy.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                    enemy.y += Math.sin(enemy.moveAngle) * enemy.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                }

                enemy.x = Math.max(0, Math.min(GAME_WIDTH - enemy.size, enemy.x));
                enemy.y = Math.max(0, Math.min(GAME_HEIGHT - enemy.size, enemy.y));

                if (distance < enemy.shootRange && (enemy.minShootRange === undefined || distance > enemy.minShootRange) && enemy.shootTimer <= 0) {
                  enemy.shootTimer = enemy.shootCooldown;
                  enemy.bulletCount = enemy.burstCount;
                  const baseAngle = Math.atan2(dy, dx);
                  if (enemy.burstFire) {
                      enemy.burstTimer = 0;
                  } else {
                      const bulletCount = enemy.burstCount;
                      for (let i = 0; i < bulletCount; i++) {
                          const spreadAngle = (Math.random() - 0.5) * enemy.bulletSpread;
                          if (enemy.name === 'Green') {
                              playSoundEffect(greenShot)
                          }
                          if (enemy.name === 'Orange') {
                                playSoundEffect(orangeShot)
                            }
                          if (enemy.name === 'Blue') {
                                playSoundEffect(blueShot)
                            }
                          if (enemy.name === 'Pink') {
                                playSoundEffect(pinkShot)
                            }
                          totBullets[enemy.name]++;
                          bullets.push({
                              x: enemy.x + enemy.size / 2,
                              y: enemy.y + enemy.size / 2,
                              speed: enemy.bulletSpeed,
                              range: enemy.bulletRange,
                              size: enemy.bulletSize,
                              distance: 0,
                              angle: baseAngle + spreadAngle,
                              followPlayer: enemy.followPlayer,
                              wrapBullets: enemy.wrapBullets,
                              color: enemy.color
                          });
                      }
                  }
              }
              
              if (enemy.burstFire && enemy.bulletCount > 0) {
                  enemy.shootTimer = enemy.shootCooldown;
                  if (enemy.burstTimer >= enemy.burstDelay * (player.slowMo ? 2 : 1)) {
                      const baseAngle = Math.atan2(dy, dx);
                      const spreadAngle = (Math.random() - 0.5) * enemy.bulletSpread;
                      if (enemy.name === 'Red') {
                            playSoundEffect(redShot)
                        }
                      if (enemy.name === 'Purple') {
                            playSoundEffect(purpleShot)
                        }
                      if (enemy.name === 'Yellow') {
                            playSoundEffect(yellowShot)
                        }
                      if (enemy.name === 'Azure') {
                            playSoundEffect(azureShot)
                        }
                      totBullets[enemy.name]++;
                      bullets.push({
                          x: enemy.x + enemy.size / 2,
                          y: enemy.y + enemy.size / 2,
                          speed: enemy.bulletSpeed,
                          range: enemy.bulletRange,
                          size: enemy.bulletSize,
                          distance: 0,
                          angle: baseAngle + spreadAngle,
                          followPlayer: enemy.followPlayer,
                          wrapBullets: enemy.wrapBullets,
                          color: enemy.color
                      });
                      enemy.bulletCount--;
                      enemy.burstTimer = 0;
                  }
                  enemy.burstTimer += deltaTime;
              }

            if (distance < enemy.spawnRange && (enemy.minSpawnRange === undefined || distance > enemy.minSpawnRange) && enemy.spawnTimer <= 0) {
                  enemy.spawnTimer = enemy.spawnCooldown;
                  enemy.spawnCount = enemy.spawnBurstCount;
                  if (enemy.spawnBurstFire) {
                      enemy.spawnBurstTimer = 0;
                  }
            }
            if (enemy.spawnBurstFire && enemy.spawnCount > 0) {
                  enemy.spawnTimer = enemy.spawnCooldown;
                  if (enemy.spawnBurstTimer >= enemy.spawnBurstDelay * (player.slowMo ? 2 : 1)) {
                      const baseAngle = Math.atan2(dy, dx);
                      const spreadAngle = (Math.random() - 0.5) * enemy.spawnSpread;
                      if (enemy.color === '#F7D358') {
                            const type = ENEMY_TYPES.find(t => t.color === '#47A3FF');
                            playSoundEffect(yellowRelease);
                            const nemy = {
                                x: enemy.x + enemy.size / 2,
                                y: enemy.y + enemy.size / 2,
                                ...type,
                                shootTimer: 0,
                                targetPlayer: true,
                                targetChangeTimer: 0,
                                moveAngle: Math.random() * Math.PI * 2
                            };
                            nemy.shootTimer = (0.5 + Math.random()/2) * nemy.shootCooldown;
                            nemy.speed = enemy.spawnEnemySpeed;
                            nemy.bulletSpeed = nemy.baseBulletSpeed;
                            enemies.push(nemy);
                            totEnemies[nemy.name]++;
                      }
                      enemy.spawnCount--;
                      enemy.spawnBurstTimer = 0;
                  }
                  enemy.spawnBurstTimer += deltaTime;
              }

              enemy.shootTimer = enemy.shootTimer - 1 * deltaTime * (player.slowMo ? 0.5 : 1);
              enemy.spawnTimer = enemy.spawnTimer - 1 * deltaTime * (player.slowMo ? 0.5 : 1);

              if (enemy.teleport && Math.random() < 0.004 * deltaTime * (player.slowMo ? 0.5 : 1)) {
                  do {
                      enemy.x = Math.random() * (GAME_WIDTH - enemy.size);
                      enemy.y = Math.random() * (GAME_HEIGHT - enemy.size);
                  } while (Math.abs(enemy.x - player.x) < player.size * 5 && Math.abs(enemy.y - player.y) < player.size * 5);
                  playSoundEffect(blueTeleport);
              }
            });
        }

        function updateBullets() {
            bullets = bullets.filter(bullet => {
                if (bullet.followPlayer) {
                    const dx = player.x + player.size/2 - bullet.x;
                    const dy = player.y + player.size/2 - bullet.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 200) {
                        const angle = Math.atan2(dy, dx);
                        bullet.angle = angle;
                    } else {
                        bullet.angle += (Math.random() - 0.5) * 0.2;
                    }
                }

                bullet.x += Math.cos(bullet.angle) * bullet.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                bullet.y += Math.sin(bullet.angle) * bullet.speed * (player.slowMo ? 0.5 : 1) * deltaTime;
                bullet.distance += bullet.speed * (player.slowMo ? 0.5 : 1) * deltaTime;

                if (bullet.wrapBullets) {
                    if (bullet.x < 0) bullet.x = GAME_WIDTH;
                    if (bullet.x > GAME_WIDTH) bullet.x = 0;
                    if (bullet.y < 0) bullet.y = GAME_HEIGHT;
                    if (bullet.y > GAME_HEIGHT) bullet.y = 0;
                }

                if (bullet.distance > bullet.range) return false;

                if (
                    bullet.x + bullet.size -1 > player.x &&
                    bullet.x < player.x + player.size -1 &&
                    bullet.y + bullet.size -1 > player.y &&
                    bullet.y < player.y + player.size -1
                ) {
                    let enemyName = ENEMY_TYPES.find(e => e.color === bullet.color).name;
                    if (player.invincible) {
                        playSoundEffect(metalHit);
                    }
                    if (!player.invincible && !player.shield) {
                        playSoundEffect(bulletHit);
                        player.gotHit = true;
                        setTimeout(function() {
                            player.gotHit = false;
                        }, 80);
                        if (player.hearts > 0){
                            player.hearts--;
                            heartsLost++;
                        }
                        lastHeartRecovery = score;
                        if (player.hearts <= 0) {
                            gameOver();
                        }
                    }
                    if (!player.invincible) {
                        let colorTemp = player.color;
                        if (player.shield) {
                            colorTemp = '#00FFFF';
                        }
                        for (let i = 0; i < 7; i++) {
                            const particle = {
                                color : colorTemp,
                                x : player.x + 10 + Math.random() * 5, 
                                y : player.y + 10 + Math.random() * 5,
                                duration : (Math.random() * 500) + 500,
                                size : (Math.random() * 4) + 3,
                                speed : (Math.random() * 1.6) + 0.5,
                                moveAngle : Math.random() * Math.PI * 2,
                                alive : true
                            }
                            setTimeout(function(){
                                particle.alive = false;
                            }, particle.duration);
                            particles.push(particle);
                        }
                    }
                    if (!player.invincible && player.shield) {
                        playSoundEffect(shieldBreak);
                        player.shield = false;
                        shieldsLost++;
                    }
                    hitBullets[enemyName]++;
                    return false;
                }
                return true;
            });
        }

        function updatePowerups() {
            powerups = powerups.filter(powerup => {
                powerup.lifespan-= deltaTime;
                if (powerup.lifespan <= 0) return false;
  
                if (
                    player.x < powerup.x + POWERUP_SIZE &&
                    player.x + player.size > powerup.x &&
                    player.y < powerup.y + POWERUP_SIZE &&
                    player.y + player.size > powerup.y
                ) {
                    playSoundEffect(popPowerUp);
                    collectedPowerups[powerup.type]++;
                    multiplier += 0.01;
                    if (powerup.type === 'slowMo'){
                        playSoundEffect(timeSlowing);
                        spawnRing (powerup.x, powerup.y, '#FF00FF');
                    }
                    if (powerup.type === 'invincible'){
                        spawnRing (powerup.x, powerup.y, '#FFD700');
                        invAnimation = true;
                    }
                    if (powerup.type === 'invincible' && playerWon === true) {
                        document.getElementById('winScreen').style.display = 'none';
                    }
                    if (powerup.type === 'heart') {
                        spawnRing (powerup.x, powerup.y, '#FF0000');
                        if (player.hearts < hearts_max) {
                            playSoundEffect(heartGain);
                            player.hearts++;
                        }
                        if (gameAlmostOver === true) {
                            if (document.getElementById('gameOver').style.display === 'block') {
                                document.getElementById('gameOver').style.display = 'none';
                                currentPlaybackRate -= 0.6;
                                backFromTheDead = true;
                            }
                        }
                    } else if (powerup.type === 'glitch') {
                        playSoundEffect(glitch);
                        spawnRing (powerup.x, powerup.y, '#00FF00');
                        bullets = [];
                        enemies.forEach(enemy => {
                            enemy.shootTimer = Math.random() * (enemy.shootCooldown - enemy.shootTimer) + enemy.shootTimer;
                            enemy.bulletCount = 0;});
                    }  else if (powerup.type === 'size') {
                        enemies = enemies.filter(enemy => {
                            if (enemy.size < 16) {
                                fadedEnemies[enemy.name]++;
                                pacifist = true;
                                return false;
                            } else {
                                if (enemy.name === "Green" || enemy.name === "Red" || enemy.name === "Orange") {
                                    enemy.size = enemy.size - 3;
                                } else {
                                    enemy.size = enemy.size - 2;}
                                if (enemy.bulletSize > 4.5) {
                                    enemy.bulletSize --;
                                }
                                return true;
                            }
                        });
                    } else {
                        if (powerup.type === 'shield') {
                            spawnRing (powerup.x, powerup.y, '#00FFFF');
                            player[powerup.type] = true;
                        } else {
                            player[powerup.type] ++;
                            setTimeout(() => {
                                if (player[powerup.type] > 0) {
                                    if (powerup.type === 'invincible') {
                                        invAnimation = false;
                                        setTimeout(() => {
                                            player[powerup.type] --;
                                        }, 500);
                                    } else {player[powerup.type] --;
                                            if (!player.slowMo) {
                                                playSoundEffect(timeBack);
                                                player[powerup.type] ++;
                                                setTimeout(() => {
                                                    player[powerup.type] --;
                                                }, 1200);
                                            }
                                    }
                                }
                            }, powerup.duration);
                        }
                    }
                    return false;
                }
                return true;
            });
        }

        function updateScoreboard() {
            const scoreDiv = document.getElementById('score');
            const heartsDiv = document.getElementById('hearts');

            scoreDiv.textContent = `Score: ${score} x ${multiplier.toFixed(2)}`;
            if (player.shield) {
                heartsDiv.textContent = `Health: ${'❤️'.repeat(player.hearts)}💙`;
            } else {
                heartsDiv.textContent = `Health: ${'❤️'.repeat(player.hearts)}`;
            }
            if (player.hearts <= 0) {
                heartsDiv.textContent = `Health: 💀`;
                if (player.shield) {
                    heartsDiv.textContent = `Health: 💀💙`;
                }
            }
            if (invAnimation) {
                heartsDiv.textContent = `Health: ${'💛'.repeat(hearts_max + 1)}`;
            }
            if (gameTOver) {
                heartsDiv.textContent = `Health: ${'💀'.repeat(hearts_max + 1)}`;
            }
        }

        const colorMapping = {
            "Green": "#45D191",
            "Red": "#FF6B6B",
            "Blue": "#3A9C97",
            "Pink": "#F14E8A",
            "Orange": "#EF9B3D",
            "Purple": "#D694E5",
            "Yellow": "#F7D358",
            "Azure": "#47A3FF",
            "slowMo": "magenta",
            "shield": "cyan",
            "invincible": "gold",
            "heart": "red",
            "glitch": "lime"
        };

        function formatStats(obj) {
            const nonZeroEntries = Object.entries(obj).filter(([key, value]) => value !== 0); 
            const formattedEntries = nonZeroEntries.map(([key, value]) => `<span style="color: ${colorMapping[key]};"> ${value}</span>`).join(' + ');
            const sum = nonZeroEntries.reduce((acc, [key, value]) => acc + value, 0);
            const result = `${formattedEntries} = ${sum}`;
            if (sum === 0) {
                return '0';
            }
            if (Object.keys(nonZeroEntries).length === 1) {
                return formattedEntries;
            }
            return result;
        }

        function closeStats() {
            document.getElementById('stats').style.display = 'none';
        }

        function openStats() {
            if (!gamePaused && !gameTOver) {
                statistician = true;
            }
            document.getElementById('totBullets').innerHTML = formatStats(totBullets);
            document.getElementById('hitBullets').innerHTML = formatStats(hitBullets);
            document.getElementById('totEnemies').innerHTML = formatStats(totEnemies);
            document.getElementById('destroyedEnemies').innerHTML = formatStats(destroyedEnemies);
            document.getElementById('eatenEnemies').innerHTML = formatStats(eatenEnemies);
            document.getElementById('fadedEnemies').innerHTML = formatStats(fadedEnemies);
            document.getElementById('totPowerups').innerHTML = formatStats(totPowerups);
            document.getElementById('collectedPowerups').innerHTML = formatStats(collectedPowerups);

            document.getElementById('heartsLost').innerHTML = heartsLost ? `<span style="color: red;"> ${heartsLost}</span>` : `${heartsLost}`;
            document.getElementById('loopsCompleted').innerHTML = loopsCompleted ? `<span style="color: gold;"> ${loopsCompleted}</span>` : `${loopsCompleted}`;
            document.getElementById('backFromTheDead').innerHTML = backFromTheDead ? `<span style="color: red;"> Hell yeah!</span>` : `Nope`;
            document.getElementById('shieldsLost').innerHTML = shieldsLost ? `<span style="color: cyan;"> ${shieldsLost}</span>` : `${shieldsLost}`;

            document.getElementById('statistician').innerHTML = statistician ? `<span style="color: #45D191;"> Of course.</span>` : "Nope";
            document.getElementById('pacifist').innerHTML = pacifist ? `<span style="color: #45D191;"> Sure...</span>` : "Nope";
            
            document.getElementById('stats').style.display = 'block';
        }

        // CONTROLS
        const keys = { w: false, a: false, s: false, d: false, Escape: false, q: false};
        
        document.addEventListener('keydown', e => {
            if (e.key in keys) keys[e.key] = true;
            if (!gameStarted && (e.key === 'w' || e.key === 'a' || e.key === 's' || e.key === 'd')) {
                startGame();
            }
            if (gamePaused && (e.key === 'Escape' || e.key === 'q')) {
                playSoundEffect(menuToggle);
                setTimeout(() => {
                    if (isMusicPlaying) {
                        backgroundMusic.volume = 0;
                        backgroundMusic = matchMusic;
                        backgroundMusic.loop = true;
                        backgroundMusic.volume = musicVolume;}
                    else {backgroundMusic.volume = 0;
                        backgroundMusic = matchMusic;}
                    document.getElementById('gamePaused').style.display = 'none';
                    document.getElementById('stats').style.display = 'none';
                    gamePaused = false;
                }, 250);
            }
        });

        document.addEventListener('keyup', e => {
            if (e.key in keys) keys[e.key] = false;
        });

        document.getElementById('resumeButton').addEventListener('click', () => {
            playSoundEffect(menuToggle);
            if (isMusicPlaying) {
                backgroundMusic.volume = 0;
                backgroundMusic = matchMusic;
                backgroundMusic.loop = true;
                backgroundMusic.volume = musicVolume;}
            else {backgroundMusic.volume = 0;
                backgroundMusic = matchMusic;}
            backgroundMusic.playbackRate = currentPlaybackRate;
            gamePaused = false;
            document.getElementById('gamePaused').style.display = 'none';
        });

        // MUSIC
        function initializeAudio() {
            if (backgroundMusic.currentTime === 0) {
                backgroundMusic.play();
            }
            backgroundMusic.loop = true;
            backgroundMusic.volume = musicVolume;
        }

        function toggleMusic() {
            if (!backgroundMusic) {
                initializeAudio();
            }

            const musicButton = document.getElementById('musicButton');

            if (isMusicPlaying) {
                backgroundMusic.volume = 0;
                musicButton.textContent = 'Music off';
                musicButton.style.backgroundColor = '#FF6B6B';
                updateSliderColor('musicSlider', true);
            } else {
                if (backgroundMusic.currentTime === 0) {
                    backgroundMusic.play();
                }
                backgroundMusic.volume = musicVolume;
                musicButton.textContent = 'Music On';
                musicButton.style.backgroundColor = '#4CAF50';
                updateSliderColor('musicSlider', false);
            }

            isMusicPlaying = !isMusicPlaying;
        }

        document.getElementById('musicButton').addEventListener('click', toggleMusic);
        document.getElementById('soundButton').addEventListener('click', toggleSound);

        window.addEventListener('load', () => {
            initializeAudio();
            backgroundMusic.play();
            backgroundMusic.volume = musicVolume;
        });

        // AUDIO
        function toggleSound() {
            const soundButton = document.getElementById('soundButton');
            if (isSoundEnabled) {
                soundButton.textContent = 'Sound Off';
                soundButton.style.backgroundColor = '#FF6B6B';
                updateSliderColor('soundSlider', true);
            } else {
                soundButton.textContent = 'Sound On';
                soundButton.style.backgroundColor = '#4CAF50';
                updateSliderColor('soundSlider', false);
            }
            isSoundEnabled = !isSoundEnabled;
        }

        function playSoundEffect(effect) {
            if (isSoundEnabled) {
                soundEffect = effect;
                if (player.slowMo && effect != timeBack) {
                    soundEffect.playbackRate = 0.5;
                } else {
                    soundEffect.playbackRate = 1;
                }
                soundEffect.volume = soundEffectsVolume;
                soundEffect.currentTime = 0;
                soundEffect.play();
            }
        }

        // SLIDERS
        document.getElementById('soundSlider').addEventListener('input', function() {
            soundEffectsVolume = this.value / 100;
            if (!isSoundEnabled) {
                toggleSound();
            }
            if (isSoundEnabled && !soundEffectsVolume) {
                
                toggleSound();
            }
        });

        document.getElementById('musicSlider').addEventListener('input', function() {
            musicVolume = this.value / 100;
            if (isMusicPlaying) {
                initializeAudio();
            } else {
                toggleMusic();
            }
            if (isMusicPlaying && !musicVolume) {
                toggleMusic();
            }
        });

        function updateSliderColor(sliderId, isRed) {
            const slider = document.getElementById(sliderId);
            slider.classList.toggle('slider-red', isRed);
            slider.classList.toggle('slider-green', !isRed);
        }

        document.getElementById('joystickSlider').addEventListener('input', function() {
            if (gamePaused || gameTOver) {
                if (!isLandscape()) {
                    document.getElementById('joystick-container').style.left = (this.value - 20) + '%';} else {document.getElementById('joystick-container').style.left = (0.9 * this.value - 4) + '%';}
                if ((this.value - 20) < 35 && !isLandscape()) {
                    document.getElementById('pauseButton').style.left = '86%';
                } else {document.getElementById('pauseButton').style.left = '3%';}
                if ((this.value - 20) < 35 && isLandscape()) {
                    document.getElementById('canvas-container').style.right = '-25%';
                    
                } else {if ((this.value - 20) >= 35 && isLandscape()) {
                    document.getElementById('canvas-container').style.right = '3%';
                }}
            }
        });

        if (!isMobileDevice()) {
            document.getElementById('joystickSlider').style.display = 'none';
            document.getElementById('pauseButton').style.display = 'none';
        }

        document.getElementById('pauseButton').addEventListener('click', () => {
            if (!gameTOver) {
                if (isSoundEnabled) {
                    playSoundEffect(menuToggle);
                }
                document.getElementById('gamePaused').style.display = 'block';
                if (isMusicPlaying) {
                    backgroundMusic.volume = 0.4;
                    setTimeout(function() {
                        backgroundMusic.volume = 0;
                        backgroundMusic = menuMusic;
                        backgroundMusic.loop = true;
                        backgroundMusic.volume = musicVolume;
                        backgroundMusic.playbackRate = 1;
                        backgroundMusic.play();}, 240);
                }
                else {
                    backgroundMusic.volume = 0;
                    backgroundMusic.playbackRate = 1;
                    backgroundMusic = menuMusic;
                }
                gamePaused = true;
            }
        });

        // MOBILE CONTROLS
        const joystickContainer = document.getElementById('joystick-container');
        const joystick = document.getElementById('joystick');
        let isDragging = false;
        let startX, startY, moveX, moveY;

        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        }

        if (isMobileDevice()) {
            document.getElementById('title').href = 'https://drive.google.com/file/d/1gl9NtrL6Am2LFeRv7gIqE_TBgarl2OR4/view?usp=sharing';
            joystickContainer.style.display = 'block';
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('winScreen').style.display = 'block';
            document.getElementById('gamePaused').style.display = 'block';
            document.getElementById('stats').style.display = 'block';
            document.getElementById('gameOver').style.top = '21%';
            document.getElementById('winScreen').style.top = '21%';
            document.getElementById('gamePaused').style.top = '21%';
            document.getElementById('stats').style.top = '21%';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('winScreen').style.display = 'none';
            document.getElementById('gamePaused').style.display = 'none';
            document.getElementById('stats').style.display = 'none';
        }

        function handleStart(e) {
            isDragging = true;
            startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
        }

        function handleMove(e) {
            if (!isDragging) return;

            e.preventDefault();
            moveX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX) - startX;
            moveY = (e.type === 'touchmove' ? e.touches[0].clientY : e.clientY) - startY;

            const distance = Math.min(50, Math.sqrt(moveX * moveX + moveY * moveY));
            const angle = Math.atan2(moveY, moveX);

            const joystickX = Math.cos(angle) * distance;
            const joystickY = Math.sin(angle) * distance;

            joystick.style.transform = `translate(calc(-50% + ${joystickX}px), calc(-50% + ${joystickY}px))`;

            keys.w = moveY < -18;
            keys.s = moveY > 18;
            keys.a = moveX < -18;
            keys.d = moveX > 18;

            if (!gameStarted && (keys.w || keys.s || keys.a || keys.d)) {
                startGame();
            }
        }

        function handleEnd() {
            isDragging = false;
            joystick.style.transform = 'translate(-50%, -50%)';

            for (let key in keys) {
                keys[key] = false;
            }
        }

        joystickContainer.addEventListener('mousedown', handleStart);
        joystickContainer.addEventListener('touchstart', handleStart);

        document.addEventListener('mousemove', handleMove);
        document.addEventListener('touchmove', handleMove, { passive: false });

        document.addEventListener('mouseup', handleEnd);
        document.addEventListener('touchend', handleEnd);


        // LANDSCAPE MODE
        function isLandscape() {
            if (window.matchMedia("(orientation: landscape)").matches) {
                document.getElementById('gameOver').style.display = 'block';
                document.getElementById('winScreen').style.display = 'block';
                document.getElementById('gamePaused').style.display = 'block';
                document.getElementById('stats').style.display = 'block';
                document.getElementById('gameOver').style.top = '30%';
                document.getElementById('winScreen').style.top = '30%';
                document.getElementById('gamePaused').style.top = '30%';
                document.getElementById('stats').style.top = '30%';
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('winScreen').style.display = 'none';
                document.getElementById('gamePaused').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
            }
            return window.matchMedia("(orientation: landscape)").matches;
        }

        document.querySelectorAll('.retryButt').forEach(button => {button.addEventListener('click', () => {
                player = {
                    x: GAME_WIDTH / 2,
                    y: GAME_HEIGHT / 2,
                    size: PLAYER_SIZE,
                    speed: 5,
                    hearts: 1,
                    shield: false,
                    invincible: 0,
                    slowMo: 0,
                    gotHit: false
                };
                enemies = [];
                bullets = [];
                powerups = [];
                score = 0;
                difficulty = 1;
                difficulty2 = 1;
                lastHeartRecovery = 0;
                gameAlmostOver = false;
                enemySpawnQueue = [...MOD8];
                step = 300;
                first = true;
                multiplier = 1;
                interval = 100;
                lastSizeUpdate = 0;
                loop = false;
                playerWon = false;
                gamePaused = false;
                gameTOver = true;
                rings = [];
                particles = [];
                invAnimation = false;
                hearts_max = 3;
                currentPlaybackRate = 1;
                statistician = false;
                pacifist = false;
                document.getElementById('mark').textContent = 'You should be dead';
                mark = "You're trash";
    
                now = performance.now();
                lastTime = now;
                deltaTime = 0;

                matchMusic = new Audio('Music-1.mp3');
                menuMusic = new Audio('Menu-mix.mp3');
                
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                document.getElementById('winScreen').style.display = 'none';
                document.getElementById('hearts').style.width = '23%';
                startGame();
                
                // STATS
                totPowerups = {};
                collectedPowerups = {};
                POWERUP_TYPES.forEach(powerup => {
                    totPowerups[powerup.type] = 0;
                    collectedPowerups[powerup.type] = 0;
                });
                
                totBullets = {};
                hitBullets = {};
                destroyedEnemies = {};
                fadedEnemies = {};
                totEnemies = {};
                eatenEnemies = {};
                ENEMY_TYPES.forEach(enemy => {
                    totBullets[enemy.name] = 0;
                    hitBullets[enemy.name] = 0;
                    destroyedEnemies[enemy.name] = 0;
                    eatenEnemies[enemy.name] = 0;
                    fadedEnemies[enemy.name] = 0;
                    totEnemies[enemy.name] = 0;
                });
                heartsLost = 0;
                loopsCompleted = 0;
                backFromTheDead = false;
                shieldsLost = 0;
            });                                                   
        });

        draw();
    </script>
</body>
</html>
